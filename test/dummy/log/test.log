  [1m[35m (0.2ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.4ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.1ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2025-12-23 02:19:35.792265', '2025-12-23 02:19:35.792268') RETURNING "key"[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Migrating to CreatePayTables (20251223021912)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mCREATE TABLE "pay_customers" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "owner_type" varchar, "owner_id" bigint, "processor" varchar NOT NULL, "processor_id" varchar, "default" boolean, "data" json, "stripe_account" varchar, "deleted_at" datetime, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "pay_customer_owner_index" ON "pay_customers" ("owner_type", "owner_id", "deleted_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_customers_on_processor_and_processor_id" ON "pay_customers" ("processor", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_merchants" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "owner_type" varchar, "owner_id" bigint, "processor" varchar NOT NULL, "processor_id" varchar, "default" boolean, "data" json, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_merchants_on_owner_type_and_owner_id_and_processor" ON "pay_merchants" ("owner_type", "owner_id", "processor")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_payment_methods" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "customer_id" bigint NOT NULL, "processor_id" varchar NOT NULL, "default" boolean, "type" varchar, "data" json, "stripe_account" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_c78c6cb84d"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_payment_methods_on_customer_id_and_processor_id" ON "pay_payment_methods" ("customer_id", "processor_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "pay_subscriptions" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "customer_id" bigint NOT NULL, "name" varchar NOT NULL, "processor_id" varchar NOT NULL, "processor_plan" varchar NOT NULL, "quantity" integer DEFAULT 1 NOT NULL, "status" varchar NOT NULL, "current_period_start" datetime, "current_period_end" datetime, "trial_ends_at" datetime, "ends_at" datetime, "metered" boolean, "pause_behavior" varchar, "pause_starts_at" datetime, "pause_resumes_at" datetime, "application_fee_percent" decimal(8,2), "metadata" json, "data" json, "stripe_account" varchar, "payment_method_id" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_b7cd64d378"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_subscriptions_on_customer_id_and_processor_id" ON "pay_subscriptions" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_subscriptions_on_metered" ON "pay_subscriptions" ("metered")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_subscriptions_on_pause_starts_at" ON "pay_subscriptions" ("pause_starts_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "customer_id" bigint NOT NULL, "subscription_id" bigint, "processor_id" varchar NOT NULL, "amount" integer NOT NULL, "currency" varchar, "application_fee_amount" integer, "amount_refunded" integer, "metadata" json, "data" json, "stripe_account" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_b19d32f835"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
, CONSTRAINT "fk_rails_44a2c276fa"
FOREIGN KEY ("subscription_id")
  REFERENCES "pay_subscriptions" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_charges_on_subscription_id" ON "pay_charges" ("subscription_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_charges_on_customer_id_and_processor_id" ON "pay_charges" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_webhooks" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "processor" varchar, "event_type" varchar, "event" json, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.0ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251223021912') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
Migrating to AddPayStiColumns (20251223021913)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "pay_customers" ADD "type" varchar[0m
  [1m[35m (0.1ms)[0m  [1m[35mALTER TABLE "pay_charges" ADD "type" varchar[0m
  [1m[35m (0.1ms)[0m  [1m[35mALTER TABLE "pay_subscriptions" ADD "type" varchar[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TEMPORARY TABLE "apay_payment_methods" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "customer_id" bigint NOT NULL, "processor_id" varchar NOT NULL, "default" boolean, "payment_method_type" varchar, "data" json, "stripe_account" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "tindex_apay_payment_methods_on_customer_id_and_processor_id" ON "apay_payment_methods" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "apay_payment_methods" ("id","customer_id","processor_id","default","payment_method_type","data","stripe_account","created_at","updated_at")
                     SELECT "id","customer_id","processor_id","default","type","data","stripe_account","created_at","updated_at" FROM "pay_payment_methods"[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE "pay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_payment_methods" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "customer_id" bigint NOT NULL, "processor_id" varchar NOT NULL, "default" boolean, "payment_method_type" varchar, "data" json, "stripe_account" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_c78c6cb84d"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_payment_methods_on_customer_id_and_processor_id" ON "pay_payment_methods" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "pay_payment_methods" ("id","customer_id","processor_id","default","payment_method_type","data","stripe_account","created_at","updated_at")
                     SELECT "id","customer_id","processor_id","default","payment_method_type","data","stripe_account","created_at","updated_at" FROM "apay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "apay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[35m (0.1ms)[0m  [1m[35mALTER TABLE "pay_payment_methods" ADD "type" varchar[0m
  [1m[35m (0.1ms)[0m  [1m[35mALTER TABLE "pay_merchants" ADD "type" varchar[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" ORDER BY "pay_customers"."id" ASC LIMIT ?[0m  [["LIMIT", 1000]]
  [1m[36mPay::Merchant Load (0.0ms)[0m  [1m[34mSELECT "pay_merchants".* FROM "pay_merchants" ORDER BY "pay_merchants"."id" ASC LIMIT ?[0m  [["LIMIT", 1000]]
  [1m[36mActiveRecord::SchemaMigration Create (0.0ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251223021913') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
Migrating to AddObjectToPayModels (20251223021914)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mALTER TABLE "pay_charges" ADD "object" json[0m
  [1m[35m (0.1ms)[0m  [1m[35mALTER TABLE "pay_customers" ADD "object" json[0m
  [1m[35m (0.1ms)[0m  [1m[35mALTER TABLE "pay_subscriptions" ADD "object" json[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.0ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251223021914') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[35m (0.3ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_charges"[0m
  [1m[35m (0.2ms)[0m  [1m[35mCREATE TABLE "pay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "amount" integer NOT NULL, "amount_refunded" integer, "application_fee_amount" integer, "created_at" datetime(6) NOT NULL, "currency" varchar, "customer_id" bigint NOT NULL, "data" json, "metadata" json, "object" json, "processor_id" varchar NOT NULL, "stripe_account" varchar, "subscription_id" bigint, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_charges_on_customer_id_and_processor_id" ON "pay_charges" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_charges_on_subscription_id" ON "pay_charges" ("subscription_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_customers"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "pay_customers" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "data" json, "default" boolean, "deleted_at" datetime, "object" json, "owner_id" bigint, "owner_type" varchar, "processor" varchar NOT NULL, "processor_id" varchar, "stripe_account" varchar, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "pay_customer_owner_index" ON "pay_customers" ("owner_type", "owner_id", "deleted_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_customers_on_processor_and_processor_id" ON "pay_customers" ("processor", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_merchants"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_merchants" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "data" json, "default" boolean, "owner_id" bigint, "owner_type" varchar, "processor" varchar NOT NULL, "processor_id" varchar, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_merchants_on_owner_type_and_owner_id_and_processor" ON "pay_merchants" ("owner_type", "owner_id", "processor")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_payment_methods" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "customer_id" bigint NOT NULL, "data" json, "default" boolean, "payment_method_type" varchar, "processor_id" varchar NOT NULL, "stripe_account" varchar, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_payment_methods_on_customer_id_and_processor_id" ON "pay_payment_methods" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_subscriptions"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "pay_subscriptions" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "application_fee_percent" decimal(8,2), "created_at" datetime(6) NOT NULL, "current_period_end" datetime, "current_period_start" datetime, "customer_id" bigint NOT NULL, "data" json, "ends_at" datetime, "metadata" json, "metered" boolean, "name" varchar NOT NULL, "object" json, "pause_behavior" varchar, "pause_resumes_at" datetime, "pause_starts_at" datetime, "payment_method_id" varchar, "processor_id" varchar NOT NULL, "processor_plan" varchar NOT NULL, "quantity" integer DEFAULT 1 NOT NULL, "status" varchar NOT NULL, "stripe_account" varchar, "trial_ends_at" datetime, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_subscriptions_on_customer_id_and_processor_id" ON "pay_subscriptions" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_subscriptions_on_metered" ON "pay_subscriptions" ("metered")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_pay_subscriptions_on_pause_starts_at" ON "pay_subscriptions" ("pause_starts_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "pay_webhooks"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_webhooks" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "event" json, "event_type" varchar, "processor" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TEMPORARY TABLE "apay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "amount" integer NOT NULL, "amount_refunded" integer, "application_fee_amount" integer, "created_at" datetime(6) NOT NULL, "currency" varchar, "customer_id" bigint NOT NULL, "data" json, "metadata" json, "object" json, "processor_id" varchar NOT NULL, "stripe_account" varchar, "subscription_id" bigint, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "tindex_apay_charges_on_subscription_id" ON "apay_charges" ("subscription_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "tindex_apay_charges_on_customer_id_and_processor_id" ON "apay_charges" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "apay_charges" ("id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at")
                     SELECT "id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at" FROM "pay_charges"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "pay_charges"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "amount" integer NOT NULL, "amount_refunded" integer, "application_fee_amount" integer, "created_at" datetime(6) NOT NULL, "currency" varchar, "customer_id" bigint NOT NULL, "data" json, "metadata" json, "object" json, "processor_id" varchar NOT NULL, "stripe_account" varchar, "subscription_id" bigint, "type" varchar, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_b19d32f835"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_charges_on_customer_id_and_processor_id" ON "pay_charges" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_charges_on_subscription_id" ON "pay_charges" ("subscription_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "pay_charges" ("id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at")
                     SELECT "id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at" FROM "apay_charges"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "apay_charges"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TEMPORARY TABLE "apay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "amount" integer NOT NULL, "amount_refunded" integer, "application_fee_amount" integer, "created_at" datetime(6) NOT NULL, "currency" varchar, "customer_id" bigint NOT NULL, "data" json, "metadata" json, "object" json, "processor_id" varchar NOT NULL, "stripe_account" varchar, "subscription_id" bigint, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "tindex_apay_charges_on_subscription_id" ON "apay_charges" ("subscription_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "tindex_apay_charges_on_customer_id_and_processor_id" ON "apay_charges" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "apay_charges" ("id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at")
                     SELECT "id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at" FROM "pay_charges"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "pay_charges"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_charges" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "amount" integer NOT NULL, "amount_refunded" integer, "application_fee_amount" integer, "created_at" datetime(6) NOT NULL, "currency" varchar, "customer_id" bigint NOT NULL, "data" json, "metadata" json, "object" json, "processor_id" varchar NOT NULL, "stripe_account" varchar, "subscription_id" bigint, "type" varchar, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_b19d32f835"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
, CONSTRAINT "fk_rails_44a2c276fa"
FOREIGN KEY ("subscription_id")
  REFERENCES "pay_subscriptions" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_charges_on_customer_id_and_processor_id" ON "pay_charges" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_charges_on_subscription_id" ON "pay_charges" ("subscription_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "pay_charges" ("id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at")
                     SELECT "id","amount","amount_refunded","application_fee_amount","created_at","currency","customer_id","data","metadata","object","processor_id","stripe_account","subscription_id","type","updated_at" FROM "apay_charges"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "apay_charges"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TEMPORARY TABLE "apay_payment_methods" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "customer_id" bigint NOT NULL, "data" json, "default" boolean, "payment_method_type" varchar, "processor_id" varchar NOT NULL, "stripe_account" varchar, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "tindex_apay_payment_methods_on_customer_id_and_processor_id" ON "apay_payment_methods" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "apay_payment_methods" ("id","created_at","customer_id","data","default","payment_method_type","processor_id","stripe_account","type","updated_at")
                     SELECT "id","created_at","customer_id","data","default","payment_method_type","processor_id","stripe_account","type","updated_at" FROM "pay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "pay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_payment_methods" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "created_at" datetime(6) NOT NULL, "customer_id" bigint NOT NULL, "data" json, "default" boolean, "payment_method_type" varchar, "processor_id" varchar NOT NULL, "stripe_account" varchar, "type" varchar, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_c78c6cb84d"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_payment_methods_on_customer_id_and_processor_id" ON "pay_payment_methods" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "pay_payment_methods" ("id","created_at","customer_id","data","default","payment_method_type","processor_id","stripe_account","type","updated_at")
                     SELECT "id","created_at","customer_id","data","default","payment_method_type","processor_id","stripe_account","type","updated_at" FROM "apay_payment_methods"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "apay_payment_methods"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TEMPORARY TABLE "apay_subscriptions" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "application_fee_percent" decimal(8,2), "created_at" datetime(6) NOT NULL, "current_period_end" datetime, "current_period_start" datetime, "customer_id" bigint NOT NULL, "data" json, "ends_at" datetime, "metadata" json, "metered" boolean, "name" varchar NOT NULL, "object" json, "pause_behavior" varchar, "pause_resumes_at" datetime, "pause_starts_at" datetime, "payment_method_id" varchar, "processor_id" varchar NOT NULL, "processor_plan" varchar NOT NULL, "quantity" integer DEFAULT 1 NOT NULL, "status" varchar NOT NULL, "stripe_account" varchar, "trial_ends_at" datetime, "type" varchar, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "tindex_apay_subscriptions_on_pause_starts_at" ON "apay_subscriptions" ("pause_starts_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "tindex_apay_subscriptions_on_metered" ON "apay_subscriptions" ("metered")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "tindex_apay_subscriptions_on_customer_id_and_processor_id" ON "apay_subscriptions" ("customer_id", "processor_id")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "apay_subscriptions" ("id","application_fee_percent","created_at","current_period_end","current_period_start","customer_id","data","ends_at","metadata","metered","name","object","pause_behavior","pause_resumes_at","pause_starts_at","payment_method_id","processor_id","processor_plan","quantity","status","stripe_account","trial_ends_at","type","updated_at")
                     SELECT "id","application_fee_percent","created_at","current_period_end","current_period_start","customer_id","data","ends_at","metadata","metered","name","object","pause_behavior","pause_resumes_at","pause_starts_at","payment_method_id","processor_id","processor_plan","quantity","status","stripe_account","trial_ends_at","type","updated_at" FROM "pay_subscriptions"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "pay_subscriptions"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "pay_subscriptions" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "application_fee_percent" decimal(8,2), "created_at" datetime(6) NOT NULL, "current_period_end" datetime, "current_period_start" datetime, "customer_id" bigint NOT NULL, "data" json, "ends_at" datetime, "metadata" json, "metered" boolean, "name" varchar NOT NULL, "object" json, "pause_behavior" varchar, "pause_resumes_at" datetime, "pause_starts_at" datetime, "payment_method_id" varchar, "processor_id" varchar NOT NULL, "processor_plan" varchar NOT NULL, "quantity" integer DEFAULT 1 NOT NULL, "status" varchar NOT NULL, "stripe_account" varchar, "trial_ends_at" datetime, "type" varchar, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_b7cd64d378"
FOREIGN KEY ("customer_id")
  REFERENCES "pay_customers" ("id")
)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_pay_subscriptions_on_customer_id_and_processor_id" ON "pay_subscriptions" ("customer_id", "processor_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_subscriptions_on_metered" ON "pay_subscriptions" ("metered")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_pay_subscriptions_on_pause_starts_at" ON "pay_subscriptions" ("pause_starts_at")[0m
  [1m[35mSQL (0.0ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("id","application_fee_percent","created_at","current_period_end","current_period_start","customer_id","data","ends_at","metadata","metered","name","object","pause_behavior","pause_resumes_at","pause_starts_at","payment_method_id","processor_id","processor_plan","quantity","status","stripe_account","trial_ends_at","type","updated_at")
                     SELECT "id","application_fee_percent","created_at","current_period_end","current_period_start","customer_id","data","ends_at","metadata","metered","name","object","pause_behavior","pause_resumes_at","pause_starts_at","payment_method_id","processor_id","processor_plan","quantity","status","stripe_account","trial_ends_at","type","updated_at" FROM "apay_subscriptions"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE "apay_subscriptions"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.0ms)[0m  [1m[32mINSERT INTO "schema_migrations" (version) VALUES (20251223021914)[0m
  [1m[35m (0.0ms)[0m  [1m[32mINSERT INTO "schema_migrations" (version) VALUES
(20251223021913),
(20251223021912);[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2025-12-23 02:20:28.575838', '2025-12-23 02:20:28.575839') RETURNING "key"[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Load (0.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('schema_sha1', 'a22ed0ff65ce30a751b9c19abad054fa6fe3c70c', '2025-12-23 02:20:28.576149', '2025-12-23 02:20:28.576150') RETURNING "key"[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.4ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:28:11.824742', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:28:11.824742');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:28:11.825695', '2026-01-23 02:28:11', '2025-11-23 02:28:11', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:28:11.825695')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:28:11"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:28:11.851955"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:28:11.854954"], ["current_period_end", "2026-12-23 02:28:11"], ["current_period_start", "2025-12-23 02:28:11"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:28:11.854954"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:28:11.856851"], ["current_period_end", "2026-12-23 02:28:11"], ["current_period_start", "2025-12-23 02:28:11"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:28:11.856851"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:28:29.861037', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:28:29.861037');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:28:29.861962', '2026-01-23 02:28:29', '2025-11-23 02:28:29', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:28:29.861962')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:28:29"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:28:29.883378"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:28:29.886034"], ["current_period_end", "2026-12-23 02:28:29"], ["current_period_start", "2025-12-23 02:28:29"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:28:29.886034"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:28:29.887832"], ["current_period_end", "2026-12-23 02:28:29"], ["current_period_start", "2025-12-23 02:28:29"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:28:29.887832"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:29:32.447431', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:29:32.447431');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:29:32.448432', '2026-01-23 02:29:32', '2025-11-23 02:29:32', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:29:32.448432')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:29:32"], ["status", "canceled"], ["updated_at", "2025-12-23 02:29:32.463492"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:29:32"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:29:32.485140"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:29:32.486944"], ["current_period_end", "2026-12-23 02:29:32"], ["current_period_start", "2025-12-23 02:29:32"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:29:32.486944"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:29:32.488648"], ["current_period_end", "2026-12-23 02:29:32"], ["current_period_start", "2025-12-23 02:29:32"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:29:32.488648"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:29:32"], ["current_period_start", "2025-12-23 02:29:32"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:29:32.491867"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:29:32.493811"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:37:10.798686', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:37:10.798686');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:37:10.799724', '2026-01-23 02:37:10', '2025-11-23 02:37:10', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:37:10.799724')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
Pay::Purchasekit::SubscriptionTest: test_pause_raises_error
-----------------------------------------------------------
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------
Pay::Purchasekit::SubscriptionTest: test_cancel_now_raises_error
----------------------------------------------------------------
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------
Pay::Purchasekit::SubscriptionTest: test_cancel_raises_error
------------------------------------------------------------
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------
Pay::Purchasekit::SubscriptionTest: test_change_quantity_raises_error
---------------------------------------------------------------------
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------
Pay::Purchasekit::SubscriptionTest: test_resume_raises_error
------------------------------------------------------------
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------
Pay::Purchasekit::SubscriptionTest: test_paused_returns_false
-------------------------------------------------------------
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------
Pay::Purchasekit::SubscriptionTest: test_swap_raises_error
----------------------------------------------------------
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:38:22.611718', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:38:22.611718')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.0ms)[0m  [1m[31mDELETE FROM "pay_subscriptions";
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:38:22.641066', '2026-01-23 02:38:22', '2025-11-23 02:38:22', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:38:22.641066')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:38:22"], ["current_period_start", "2025-12-23 02:38:22"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:38:22.647842"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:38:22.654433"], ["current_period_end", "2026-12-23 02:38:22"], ["current_period_start", "2025-12-23 02:38:22"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:38:22.654433"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:38:22"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:38:22.656375"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:38:22.657782"], ["current_period_end", "2026-12-23 02:38:22"], ["current_period_start", "2025-12-23 02:38:22"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:38:22.657782"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:38:22.672823"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
PurchaseKit::Pay::WebhooksControllerTest - test_ignores_unregistered_event_types: NameError raised.
If you expected this exception, use `assert_raises` as near to the code that raises as possible.
Other block based assertions (e.g. `assert_difference`) can be used, as long as `assert_raises` is inside their block.

  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
PurchaseKit::Pay::WebhooksControllerTest - test_rejects_invalid_signature: NameError raised.
If you expected this exception, use `assert_raises` as near to the code that raises as possible.
Other block based assertions (e.g. `assert_difference`) can be used, as long as `assert_raises` is inside their block.

  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
PurchaseKit::Pay::WebhooksControllerTest - test_accepts_request_without_signature_when_secret_blank: NameError raised.
If you expected this exception, use `assert_raises` as near to the code that raises as possible.
Other block based assertions (e.g. `assert_difference`) can be used, as long as `assert_raises` is inside their block.

  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
PurchaseKit::Pay::WebhooksControllerTest - test_rejects_missing_signature: NameError raised.
If you expected this exception, use `assert_raises` as near to the code that raises as possible.
Other block based assertions (e.g. `assert_difference`) can be used, as long as `assert_raises` is inside their block.

  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
PurchaseKit::Pay::WebhooksControllerTest - test_accepts_valid_signature: NameError raised.
If you expected this exception, use `assert_raises` as near to the code that raises as possible.
Other block based assertions (e.g. `assert_difference`) can be used, as long as `assert_raises` is inside their block.

  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:38:22"], ["status", "canceled"], ["updated_at", "2025-12-23 02:38:22.699215"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_raises_not_found_for_missing_customer
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:40:07.639727', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:40:07.639727');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:40:07.640676', '2026-01-23 02:40:07', '2025-11-23 02:40:07', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:40:07.640676')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:40:07.662068"], ["current_period_end", "2026-12-23 02:40:07"], ["current_period_start", "2025-12-23 02:40:07"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:40:07.662068"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:40:07.665237"], ["current_period_end", "2026-12-23 02:40:07"], ["current_period_start", "2025-12-23 02:40:07"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:40:07.665237"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:40:07"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:40:07.667317"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:40:07"], ["status", "canceled"], ["updated_at", "2025-12-23 02:40:07.669029"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:07 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:07Z", "current_period_end"=>"2026-12-23T02:40:07Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:07Z", "current_period_end"=>"2026-12-23T02:40:07Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:07 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:07Z", "current_period_end"=>"2026-12-23T02:40:07Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:07Z", "current_period_end"=>"2026-12-23T02:40:07Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:40:07.705723"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:40:07Z\",\"current_period_end\":\"2026-12-23T02:40:07Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:40:07.705723"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: eac96525-0fd5-4a7f-8cfb-c1e7a052b30b) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:07 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:07 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:07Z", "current_period_end"=>"2026-12-23T02:40:07Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:07Z", "current_period_end"=>"2026-12-23T02:40:07Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:40:07.708537"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:40:07Z\",\"current_period_end\":\"2026-12-23T02:40:07Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:40:07.708537"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 1f36d9a2-d8ac-406c-a8f9-b1c67c93f13b) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:07 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:07Z", "current_period_end"=>"2026-12-23T02:40:07Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:07Z", "current_period_end"=>"2026-12-23T02:40:07Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:07 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:07Z", "current_period_end"=>"2026-12-23T02:40:07Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:07Z", "current_period_end"=>"2026-12-23T02:40:07Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:40:07.710688"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:40:07Z\",\"current_period_end\":\"2026-12-23T02:40:07Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:40:07.710688"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: d68ad521-2b77-42f9-97e2-d1e42932c2ec) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:40:07"], ["current_period_start", "2025-12-23 02:40:07"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:40:07.722517"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:40:07.724480"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_raises_not_found_for_missing_customer
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:40:07 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:7:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:49:in `block in test_create_raises_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/assertions.rb:429:in `assert_raises'
activesupport (8.1.1) lib/active_support/testing/assertions.rb:35:in `assert_raises'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_raises_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:40:07 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:40:07 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.6ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:40:25.232062', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:40:25.232062');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:40:25.233030', '2026-01-23 02:40:25', '2025-11-23 02:40:25', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:40:25.233030')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:40:25.247865"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:40:25"], ["current_period_start", "2025-12-23 02:40:25"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:40:25.250267"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:25 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:25Z", "current_period_end"=>"2026-12-23T02:40:25Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:25Z", "current_period_end"=>"2026-12-23T02:40:25Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:40:25.276564"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:40:25Z\",\"current_period_end\":\"2026-12-23T02:40:25Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:40:25.276564"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: baf2eaf9-033b-4def-974e-ad36f0b5b7a1) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:25 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:25Z", "current_period_end"=>"2026-12-23T02:40:25Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:25Z", "current_period_end"=>"2026-12-23T02:40:25Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:25 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:25Z", "current_period_end"=>"2026-12-23T02:40:25Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:25Z", "current_period_end"=>"2026-12-23T02:40:25Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:40:25.281090"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:40:25Z\",\"current_period_end\":\"2026-12-23T02:40:25Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:40:25.281090"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: aa76cff7-c5ef-432f-ab4c-a48778538593) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:25 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:25Z", "current_period_end"=>"2026-12-23T02:40:25Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:25Z", "current_period_end"=>"2026-12-23T02:40:25Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:40:25.282424"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:40:25Z\",\"current_period_end\":\"2026-12-23T02:40:25Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:40:25.282424"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: c7ada0e5-742a-4286-ae63-1d895e486c33) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:25 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:25 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:25Z", "current_period_end"=>"2026-12-23T02:40:25Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:25Z", "current_period_end"=>"2026-12-23T02:40:25Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:40:25"], ["status", "canceled"], ["updated_at", "2025-12-23 02:40:25.286371"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:40:25.306057"], ["current_period_end", "2026-12-23 02:40:25"], ["current_period_start", "2025-12-23 02:40:25"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:40:25.306057"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:40:25"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:40:25.308177"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:40:25.309627"], ["current_period_end", "2026-12-23 02:40:25"], ["current_period_start", "2025-12-23 02:40:25"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:40:25.309627"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:40:25 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 13ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 8.5ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:40:25 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 0.9ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:40:25 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:7:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:40:40.039140', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:40:40.039140');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:40:40.040051', '2026-01-23 02:40:40', '2025-11-23 02:40:40', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:40:40.040051')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:40:40"], ["current_period_start", "2025-12-23 02:40:40"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:40:40.058859"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:40:40"], ["status", "canceled"], ["updated_at", "2025-12-23 02:40:40.090107"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:40:40 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 4ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:40:40 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 0.9ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:40:40 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:7:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:40 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:40Z", "current_period_end"=>"2026-12-23T02:40:40Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:40Z", "current_period_end"=>"2026-12-23T02:40:40Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:40:40.184816"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:40:40Z\",\"current_period_end\":\"2026-12-23T02:40:40Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:40:40.184816"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 18c6623e-c83c-4291-ac93-0e4c999cebf0) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:40 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:40Z", "current_period_end"=>"2026-12-23T02:40:40Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:40Z", "current_period_end"=>"2026-12-23T02:40:40Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:40:40.186747"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:40:40Z\",\"current_period_end\":\"2026-12-23T02:40:40Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:40:40.186747"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: a472f387-057e-4ab3-9607-3cb00b557120) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:40 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:40Z", "current_period_end"=>"2026-12-23T02:40:40Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:40Z", "current_period_end"=>"2026-12-23T02:40:40Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:40 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:40Z", "current_period_end"=>"2026-12-23T02:40:40Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:40Z", "current_period_end"=>"2026-12-23T02:40:40Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:40:40.189099"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:40:40Z\",\"current_period_end\":\"2026-12-23T02:40:40Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:40:40.189099"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 00e50f94-6868-4c47-9d55-71bbb0c4a55b) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:40 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:40:40 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:40Z", "current_period_end"=>"2026-12-23T02:40:40Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:40:40Z", "current_period_end"=>"2026-12-23T02:40:40Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:40:40.199467"], ["current_period_end", "2026-12-23 02:40:40"], ["current_period_start", "2025-12-23 02:40:40"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:40:40.199467"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:40:40"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:40:40.201401"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:40:40.202777"], ["current_period_end", "2026-12-23 02:40:40"], ["current_period_start", "2025-12-23 02:40:40"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:40:40.202777"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:40:40.207837"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:41:17.483409', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:41:17.483409')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.0ms)[0m  [1m[31mDELETE FROM "pay_subscriptions";
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:41:17.527121', '2026-01-23 02:41:17', '2025-11-23 02:41:17', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:41:17.527121')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:41:17"], ["current_period_start", "2025-12-23 02:41:17"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:41:17.529091"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:41:17 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:41:17Z", "current_period_end"=>"2026-12-23T02:41:17Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:41:17Z", "current_period_end"=>"2026-12-23T02:41:17Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:41:17 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:41:17Z", "current_period_end"=>"2026-12-23T02:41:17Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:41:17Z", "current_period_end"=>"2026-12-23T02:41:17Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:41:17.549110"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:41:17Z\",\"current_period_end\":\"2026-12-23T02:41:17Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:41:17.549110"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 3910efca-2589-40fb-866e-d92668ddd576) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:41:17 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:41:17Z", "current_period_end"=>"2026-12-23T02:41:17Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:41:17Z", "current_period_end"=>"2026-12-23T02:41:17Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:41:17.550936"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:41:17Z\",\"current_period_end\":\"2026-12-23T02:41:17Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:41:17.550936"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 37fbdc96-ab1a-40c6-891f-2f7530d17e62) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:41:17 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:41:17 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:41:17Z", "current_period_end"=>"2026-12-23T02:41:17Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:41:17Z", "current_period_end"=>"2026-12-23T02:41:17Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:41:17.555708"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:41:17Z\",\"current_period_end\":\"2026-12-23T02:41:17Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:41:17.555708"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 77fac267-fc01-407d-bf1c-7f032dffbed2) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:41:17 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:41:17Z", "current_period_end"=>"2026-12-23T02:41:17Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:41:17Z", "current_period_end"=>"2026-12-23T02:41:17Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:41:17.560054"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:41:17"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:41:17.567323"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:41:17.568923"], ["current_period_end", "2026-12-23 02:41:17"], ["current_period_start", "2025-12-23 02:41:17"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:41:17.568923"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:41:17.570657"], ["current_period_end", "2026-12-23 02:41:17"], ["current_period_start", "2025-12-23 02:41:17"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:41:17.570657"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:41:17 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 3.9ms | GC: 3.4ms)
Completed 200 OK in 16ms (Views: 7.5ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 10.5ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.5ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:41:17 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 1ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.9ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:7:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:41:17 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:41:17"], ["status", "canceled"], ["updated_at", "2025-12-23 02:41:17.649691"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:42:48.951292', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:42:48.951292');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:42:48.952111', '2026-01-23 02:42:48', '2025-11-23 02:42:48', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:42:48.952111')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:42:48"], ["current_period_start", "2025-12-23 02:42:48"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:42:48.969072"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:42:48.984296"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:42:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:42:49Z", "current_period_end"=>"2026-12-23T02:42:49Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:42:49Z", "current_period_end"=>"2026-12-23T02:42:49Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:42:49.011123"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:42:49Z\",\"current_period_end\":\"2026-12-23T02:42:49Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:42:49.011123"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 4e7eefc3-0350-4b7f-bfbe-0a55d64eafbd) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:42:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:42:49Z", "current_period_end"=>"2026-12-23T02:42:49Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:42:49Z", "current_period_end"=>"2026-12-23T02:42:49Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:42:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:42:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:42:49Z", "current_period_end"=>"2026-12-23T02:42:49Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:42:49Z", "current_period_end"=>"2026-12-23T02:42:49Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:42:49.016444"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:42:49Z\",\"current_period_end\":\"2026-12-23T02:42:49Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:42:49.016444"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: f9d16b46-755d-495a-b15f-7f01caff9434) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:42:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:42:49Z", "current_period_end"=>"2026-12-23T02:42:49Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:42:49Z", "current_period_end"=>"2026-12-23T02:42:49Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:42:49.017675"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:42:49Z\",\"current_period_end\":\"2026-12-23T02:42:49Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:42:49.017675"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: f0d66e3b-5900-4149-8065-d72b5edc0969) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:42:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:42:49Z", "current_period_end"=>"2026-12-23T02:42:49Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:42:49Z", "current_period_end"=>"2026-12-23T02:42:49Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-01-23 02:42:49"], ["current_period_start", "2025-12-23 02:42:49"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:42:49.028012"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.2ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:42:49.029747"], ["current_period_end", "2026-12-23 02:42:49"], ["current_period_start", "2025-12-23 02:42:49"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:42:49.029747"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:42:49.031591"], ["current_period_end", "2026-12-23 02:42:49"], ["current_period_start", "2025-12-23 02:42:49"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:42:49.031591"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:42:49"], ["status", "canceled"], ["updated_at", "2025-12-23 02:42:49.042497"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:42:49 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.6ms | GC: 0.0ms)
Completed 200 OK in 6ms (Views: 2.3ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.2ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:42:49 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.7ms | GC: 0.6ms)
Completed 200 OK in 6ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 5.3ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:42:49 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 1ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.8ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:7:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:45:13.332046', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:45:13.332046');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:45:13.332997', '2026-01-23 02:45:13', '2025-11-23 02:45:13', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:45:13.332997')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:45:13"], ["current_period_start", "2025-12-23 02:45:13"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:45:13.350781"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:45:13.352967"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:13 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:13Z", "current_period_end"=>"2026-12-23T02:45:13Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:13Z", "current_period_end"=>"2026-12-23T02:45:13Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:13 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:13 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:13Z", "current_period_end"=>"2026-12-23T02:45:13Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:13Z", "current_period_end"=>"2026-12-23T02:45:13Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:13.382590"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:13Z\",\"current_period_end\":\"2026-12-23T02:45:13Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:13.382590"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 298aa91c-abd7-4684-88c2-5b5f3c2265c7) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:13 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:13Z", "current_period_end"=>"2026-12-23T02:45:13Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:13Z", "current_period_end"=>"2026-12-23T02:45:13Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:13 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:13Z", "current_period_end"=>"2026-12-23T02:45:13Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:13Z", "current_period_end"=>"2026-12-23T02:45:13Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:13.385285"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:13Z\",\"current_period_end\":\"2026-12-23T02:45:13Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:13.385285"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 65591c9d-5b74-4a51-982b-5fcfc6a4b2ac) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:13 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:13Z", "current_period_end"=>"2026-12-23T02:45:13Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:13Z", "current_period_end"=>"2026-12-23T02:45:13Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:13.386533"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:13Z\",\"current_period_end\":\"2026-12-23T02:45:13Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:13.386533"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: f267f3b3-4a66-416a-8a16-640bbb209b78) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:13 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.6ms | GC: 0.0ms)
Completed 200 OK in 6ms (Views: 2.3ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:13 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:13 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:7:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:45:13"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:45:13.498764"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:45:13.500514"], ["current_period_end", "2026-12-23 02:45:13"], ["current_period_start", "2025-12-23 02:45:13"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:45:13.500514"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.0ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:45:13.502194"], ["current_period_end", "2026-12-23 02:45:13"], ["current_period_start", "2025-12-23 02:45:13"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:45:13.502194"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:45:13"], ["status", "canceled"], ["updated_at", "2025-12-23 02:45:13.504191"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:45:24.049596', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:45:24.049596');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:45:24.050431', '2026-01-23 02:45:24', '2025-11-23 02:45:24', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:45:24.050431')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:45:24.067602"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:45:24.092692"], ["current_period_end", "2026-12-23 02:45:24"], ["current_period_start", "2025-12-23 02:45:24"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:45:24.092692"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:45:24"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:45:24.094906"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:45:24.096379"], ["current_period_end", "2026-12-23 02:45:24"], ["current_period_start", "2025-12-23 02:45:24"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:45:24.096379"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:45:24"], ["current_period_start", "2025-12-23 02:45:24"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:45:24.113780"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:24 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:24 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:24Z", "current_period_end"=>"2026-12-23T02:45:24Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:24Z", "current_period_end"=>"2026-12-23T02:45:24Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:24.138942"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:24Z\",\"current_period_end\":\"2026-12-23T02:45:24Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:24.138942"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 9d152685-cd60-48e4-8c61-9ea03ed7e572) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:24 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:24Z", "current_period_end"=>"2026-12-23T02:45:24Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:24Z", "current_period_end"=>"2026-12-23T02:45:24Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:24 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:24Z", "current_period_end"=>"2026-12-23T02:45:24Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:24Z", "current_period_end"=>"2026-12-23T02:45:24Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:24.141660"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:24Z\",\"current_period_end\":\"2026-12-23T02:45:24Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:24.141660"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 229152b2-77d1-4b09-9e0b-348a35f2a5a4) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:24 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:24Z", "current_period_end"=>"2026-12-23T02:45:24Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:24Z", "current_period_end"=>"2026-12-23T02:45:24Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:24.142954"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:24Z\",\"current_period_end\":\"2026-12-23T02:45:24Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:24.142954"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 40e34207-f6ac-4db3-8b56-6c09ce1c5905) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:24 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:24Z", "current_period_end"=>"2026-12-23T02:45:24Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:24Z", "current_period_end"=>"2026-12-23T02:45:24Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:24 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.2ms | GC: 0.0ms)
Completed 200 OK in 5ms (Views: 0.1ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.2ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:24 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.2ms | GC: 0.0ms)
Completed 200 OK in 21ms (Views: 1.2ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 18.3ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:24 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:7:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:45:24"], ["status", "canceled"], ["updated_at", "2025-12-23 02:45:24.238394"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:45:30.114108', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:45:30.114108');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:45:30.114888', '2026-01-23 02:45:30', '2025-11-23 02:45:30', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:45:30.114888')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:45:30"], ["current_period_start", "2025-12-23 02:45:30"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:45:30.131916"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:45:30"], ["status", "canceled"], ["updated_at", "2025-12-23 02:45:30.149098"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:45:30"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:45:30.165287"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:45:30.167054"], ["current_period_end", "2026-12-23 02:45:30"], ["current_period_start", "2025-12-23 02:45:30"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:45:30.167054"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:45:30.168770"], ["current_period_end", "2026-12-23 02:45:30"], ["current_period_start", "2025-12-23 02:45:30"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:45:30.168770"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:45:30.170888"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:30 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:30Z", "current_period_end"=>"2026-12-23T02:45:30Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:30Z", "current_period_end"=>"2026-12-23T02:45:30Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:30.205169"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:30Z\",\"current_period_end\":\"2026-12-23T02:45:30Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:30.205169"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 89f9c92f-78da-40ef-b29d-c751896ee22b) to Test(default) with arguments: 1
Completed 200 OK in 3ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Load (0.1ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:30 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:30Z", "current_period_end"=>"2026-12-23T02:45:30Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:30Z", "current_period_end"=>"2026-12-23T02:45:30Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:30 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:30Z", "current_period_end"=>"2026-12-23T02:45:30Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:30Z", "current_period_end"=>"2026-12-23T02:45:30Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:30 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:30Z", "current_period_end"=>"2026-12-23T02:45:30Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:30Z", "current_period_end"=>"2026-12-23T02:45:30Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:30.209550"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:30Z\",\"current_period_end\":\"2026-12-23T02:45:30Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:30.209550"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 693ff3c4-874c-4421-aeb1-8c82ee09924b) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:30 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:30Z", "current_period_end"=>"2026-12-23T02:45:30Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:30Z", "current_period_end"=>"2026-12-23T02:45:30Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:30.210839"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:30Z\",\"current_period_end\":\"2026-12-23T02:45:30Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:30.210839"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: df549990-6727-4444-86c5-abd38393cef4) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:30 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:30 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.5ms | GC: 0.0ms)
Completed 200 OK in 7ms (Views: 1.6ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 2.3ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:30 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:7:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:30 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:45:33.722956', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:45:33.722956');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:45:33.723980', '2026-01-23 02:45:33', '2025-11-23 02:45:33', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:45:33.723980')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:45:33.745343"], ["current_period_end", "2026-12-23 02:45:33"], ["current_period_start", "2025-12-23 02:45:33"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:45:33.745343"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:45:33.748038"], ["current_period_end", "2026-12-23 02:45:33"], ["current_period_start", "2025-12-23 02:45:33"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:45:33.748038"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:45:33"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:45:33.749828"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:45:33.753017"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:45:33"], ["status", "canceled"], ["updated_at", "2025-12-23 02:45:33.755018"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:33 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:7:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:33 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:45:33 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.5ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:33 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:33Z", "current_period_end"=>"2026-12-23T02:45:33Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:33Z", "current_period_end"=>"2026-12-23T02:45:33Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:33 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:33Z", "current_period_end"=>"2026-12-23T02:45:33Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:33Z", "current_period_end"=>"2026-12-23T02:45:33Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:33 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:33 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:33Z", "current_period_end"=>"2026-12-23T02:45:33Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:33Z", "current_period_end"=>"2026-12-23T02:45:33Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:33.861021"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:33Z\",\"current_period_end\":\"2026-12-23T02:45:33Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:33.861021"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: db71a5b4-1b8e-4871-9324-ff8d8b4a17de) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:33 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:33Z", "current_period_end"=>"2026-12-23T02:45:33Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:33Z", "current_period_end"=>"2026-12-23T02:45:33Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:33.862498"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:33Z\",\"current_period_end\":\"2026-12-23T02:45:33Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:33.862498"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: ae58c814-6217-4cae-9876-d6c651afe8fc) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:45:33 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:33Z", "current_period_end"=>"2026-12-23T02:45:33Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:45:33Z", "current_period_end"=>"2026-12-23T02:45:33Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:45:33.863761"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:45:33Z\",\"current_period_end\":\"2026-12-23T02:45:33Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:45:33.863761"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 269ad4c0-68ae-4c7b-97e3-1768b6fc5041) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:45:33"], ["current_period_start", "2025-12-23 02:45:33"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:45:33.865776"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 02:49:44.710339', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 02:49:44.710339');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 02:49:44.711434', '2026-01-23 02:49:44', '2025-11-23 02:49:44', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 02:49:44.711434')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 02:49:44.729450"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 02:49:44"], ["status", "canceled"], ["updated_at", "2025-12-23 02:49:44.750711"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:49:44.762408"], ["current_period_end", "2026-12-23 02:49:44"], ["current_period_start", "2025-12-23 02:49:44"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:49:44.762408"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 02:49:44.764483"], ["current_period_end", "2026-12-23 02:49:44"], ["current_period_start", "2025-12-23 02:49:44"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 02:49:44.764483"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 02:49:44"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:49:44.766192"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:49:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:49:44Z", "current_period_end"=>"2026-12-23T02:49:44Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:49:44Z", "current_period_end"=>"2026-12-23T02:49:44Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.2ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:49:44.793544"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:49:44Z\",\"current_period_end\":\"2026-12-23T02:49:44Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:49:44.793544"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 673f34b9-9b78-4a69-9109-15516a6f3bc2) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.3ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:49:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:49:44Z", "current_period_end"=>"2026-12-23T02:49:44Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:49:44Z", "current_period_end"=>"2026-12-23T02:49:44Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:49:44.797660"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:49:44Z\",\"current_period_end\":\"2026-12-23T02:49:44Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:49:44.797660"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: d58c4163-09b5-4129-8a6b-b0eaaa78168e) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:49:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:49:44Z", "current_period_end"=>"2026-12-23T02:49:44Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:49:44Z", "current_period_end"=>"2026-12-23T02:49:44Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 02:49:44.799050"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T02:49:44Z\",\"current_period_end\":\"2026-12-23T02:49:44Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 02:49:44.799050"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 68d89191-fd88-42ee-a13d-bbd1ee28dbe7) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:49:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:49:44Z", "current_period_end"=>"2026-12-23T02:49:44Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:49:44Z", "current_period_end"=>"2026-12-23T02:49:44Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:49:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:49:44Z", "current_period_end"=>"2026-12-23T02:49:44Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T02:49:44Z", "current_period_end"=>"2026-12-23T02:49:44Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 21:49:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:49:44 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 5ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.2ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:49:44 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:7:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 21:49:44 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.5ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 02:49:44"], ["current_period_start", "2025-12-23 02:49:44"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 02:49:44.894032"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.3ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.7ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 03:29:49.828621', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 03:29:49.828621');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 03:29:49.828671', '2026-01-23 03:29:49', '2025-11-23 03:29:49', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 03:29:49.828671')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 03:29:49"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 03:29:49.850228"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 03:29:49.853202"], ["current_period_end", "2026-12-23 03:29:49"], ["current_period_start", "2025-12-23 03:29:49"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 03:29:49.853202"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 03:29:49.854951"], ["current_period_end", "2026-12-23 03:29:49"], ["current_period_start", "2025-12-23 03:29:49"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 03:29:49.854951"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 03:29:49"], ["current_period_start", "2025-12-23 03:29:49"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 03:29:49.857384"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 03:29:49.889306"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 03:29:49"], ["status", "canceled"], ["updated_at", "2025-12-23 03:29:49.891414"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 22:29:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T03:29:49Z", "current_period_end"=>"2026-12-23T03:29:49Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T03:29:49Z", "current_period_end"=>"2026-12-23T03:29:49Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 03:29:49.917421"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T03:29:49Z\",\"current_period_end\":\"2026-12-23T03:29:49Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 03:29:49.917421"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 9aa9f434-c3a0-4a06-9b65-cd0aa43a589a) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 22:29:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T03:29:49Z", "current_period_end"=>"2026-12-23T03:29:49Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T03:29:49Z", "current_period_end"=>"2026-12-23T03:29:49Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 03:29:49.919768"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T03:29:49Z\",\"current_period_end\":\"2026-12-23T03:29:49Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 03:29:49.919768"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: ebafed21-bfd5-4e32-a7e6-1cec62ccc214) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 22:29:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 22:29:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T03:29:49Z", "current_period_end"=>"2026-12-23T03:29:49Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T03:29:49Z", "current_period_end"=>"2026-12-23T03:29:49Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 03:29:49.921981"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T03:29:49Z\",\"current_period_end\":\"2026-12-23T03:29:49Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 03:29:49.921981"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 10bd82da-d592-416b-af32-71011cbf3c82) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 22:29:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T03:29:49Z", "current_period_end"=>"2026-12-23T03:29:49Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T03:29:49Z", "current_period_end"=>"2026-12-23T03:29:49Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-22 22:29:49 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T03:29:49Z", "current_period_end"=>"2026-12-23T03:29:49Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T03:29:49Z", "current_period_end"=>"2026-12-23T03:29:49Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 22:29:49 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.7ms | GC: 0.0ms)
Completed 200 OK in 7ms (Views: 1.9ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.2ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 22:29:49 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-22 22:29:49 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.8ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.5ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 12:19:22.240939', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 12:19:22.240939');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 12:19:22.241963', '2026-01-23 12:19:22', '2025-11-23 12:19:22', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 12:19:22.241963')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 12:19:22.260233"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 07:19:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T12:19:22Z", "current_period_end"=>"2026-12-23T12:19:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T12:19:22Z", "current_period_end"=>"2026-12-23T12:19:22Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 12:19:22.298799"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T12:19:22Z\",\"current_period_end\":\"2026-12-23T12:19:22Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 12:19:22.298799"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 767e3fb7-bc39-4945-a424-b920cb02db43) to Test(default) with arguments: 1
Completed 200 OK in 3ms (ActiveRecord: 0.3ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 07:19:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T12:19:22Z", "current_period_end"=>"2026-12-23T12:19:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T12:19:22Z", "current_period_end"=>"2026-12-23T12:19:22Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 12:19:22.302874"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T12:19:22Z\",\"current_period_end\":\"2026-12-23T12:19:22Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 12:19:22.302874"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 35406a6d-77ea-4daf-8d57-ee1e57d15e67) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 07:19:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T12:19:22Z", "current_period_end"=>"2026-12-23T12:19:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T12:19:22Z", "current_period_end"=>"2026-12-23T12:19:22Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 12:19:22.305003"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T12:19:22Z\",\"current_period_end\":\"2026-12-23T12:19:22Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 12:19:22.305003"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 6771e179-edf8-4b69-82d8-da666f833563) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 07:19:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T12:19:22Z", "current_period_end"=>"2026-12-23T12:19:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T12:19:22Z", "current_period_end"=>"2026-12-23T12:19:22Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 07:19:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 07:19:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T12:19:22Z", "current_period_end"=>"2026-12-23T12:19:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T12:19:22Z", "current_period_end"=>"2026-12-23T12:19:22Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 12:19:22"], ["status", "canceled"], ["updated_at", "2025-12-23 12:19:22.316857"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 12:19:22"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 12:19:22.329555"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 12:19:22.331682"], ["current_period_end", "2026-12-23 12:19:22"], ["current_period_start", "2025-12-23 12:19:22"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 12:19:22.331682"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 12:19:22.333707"], ["current_period_end", "2026-12-23 12:19:22"], ["current_period_start", "2025-12-23 12:19:22"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 12:19:22.333707"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 12:19:22"], ["current_period_start", "2025-12-23 12:19:22"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 12:19:22.350807"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 07:19:22 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 2.6ms | GC: 1.9ms)
Completed 200 OK in 16ms (Views: 7.4ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 8.2ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 07:19:22 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 3ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 2.5ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 07:19:22 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.7ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 13:20:28.082914', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 13:20:28.082914');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 13:20:28.083953', '2026-01-23 13:20:28', '2025-11-23 13:20:28', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 13:20:28.083953')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 13:20:28"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 13:20:28.106931"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 13:20:28"], ["current_period_start", "2025-12-23 13:20:28"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 13:20:28.109773"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 13:20:28"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 13:20:28.111928"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 13:20:35.764858', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 13:20:35.764858');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 13:20:35.765398', '2026-01-23 13:20:35', '2025-11-23 13:20:35', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 13:20:35.765398')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 13:20:35.773207"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 08:20:35 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.1ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 08:20:35 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.6ms | GC: 0.0ms)
Completed 200 OK in 3ms (Views: 1.2ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 08:20:35 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 08:20:35 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T13:20:35Z", "current_period_end"=>"2026-12-23T13:20:35Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T13:20:35Z", "current_period_end"=>"2026-12-23T13:20:35Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 13:20:35.901832"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T13:20:35Z\",\"current_period_end\":\"2026-12-23T13:20:35Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 13:20:35.901832"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 33ef3482-3544-4996-a74b-f48d3a921c35) to Test(default) with arguments: 1
Completed 200 OK in 3ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 08:20:35 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T13:20:35Z", "current_period_end"=>"2026-12-23T13:20:35Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T13:20:35Z", "current_period_end"=>"2026-12-23T13:20:35Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 08:20:35 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T13:20:35Z", "current_period_end"=>"2026-12-23T13:20:35Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T13:20:35Z", "current_period_end"=>"2026-12-23T13:20:35Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 13:20:35.904643"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T13:20:35Z\",\"current_period_end\":\"2026-12-23T13:20:35Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 13:20:35.904643"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 6c605c64-ed4c-4e8f-80e2-591d13d953c4) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 08:20:35 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 08:20:35 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T13:20:35Z", "current_period_end"=>"2026-12-23T13:20:35Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T13:20:35Z", "current_period_end"=>"2026-12-23T13:20:35Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 08:20:35 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T13:20:35Z", "current_period_end"=>"2026-12-23T13:20:35Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T13:20:35Z", "current_period_end"=>"2026-12-23T13:20:35Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 13:20:35.907692"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T13:20:35Z\",\"current_period_end\":\"2026-12-23T13:20:35Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 13:20:35.907692"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: cfd3eec2-c27b-4e1a-879d-baaa08997c42) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 13:20:35.916080"], ["current_period_end", "2026-12-23 13:20:35"], ["current_period_start", "2025-12-23 13:20:35"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 13:20:35.916080"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 13:20:35"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 13:20:35.918127"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.0ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 13:20:35.919509"], ["current_period_end", "2026-12-23 13:20:35"], ["current_period_start", "2025-12-23 13:20:35"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 13:20:35.919509"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 13:20:35"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 13:20:35.921661"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 13:20:35"], ["current_period_start", "2025-12-23 13:20:35"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 13:20:35.922787"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 13:20:35"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 13:20:35.924115"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 13:20:35"], ["status", "canceled"], ["updated_at", "2025-12-23 13:20:35.925408"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 16:07:11.313035', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 16:07:11.313035');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 16:07:11.313976', '2026-01-23 16:07:11', '2025-11-23 16:07:11', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 16:07:11.313976')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.2ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 16:07:11.338268"], ["current_period_end", "2026-12-23 16:07:11"], ["current_period_start", "2025-12-23 16:07:11"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 16:07:11.338268"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 16:07:11.341078"], ["current_period_end", "2026-12-23 16:07:11"], ["current_period_start", "2025-12-23 16:07:11"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 16:07:11.341078"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 16:07:11"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:07:11.342876"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:07:11 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:07:11Z", "current_period_end"=>"2026-12-23T16:07:11Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:07:11Z", "current_period_end"=>"2026-12-23T16:07:11Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:07:11 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:07:11 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:07:11Z", "current_period_end"=>"2026-12-23T16:07:11Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:07:11Z", "current_period_end"=>"2026-12-23T16:07:11Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 16:07:11.389143"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T16:07:11Z\",\"current_period_end\":\"2026-12-23T16:07:11Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 16:07:11.389143"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 884c6283-4ae4-4bda-87f8-3f133f5188db) to Test(default) with arguments: 1
Completed 200 OK in 4ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 2.1ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:07:11 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:07:11Z", "current_period_end"=>"2026-12-23T16:07:11Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:07:11Z", "current_period_end"=>"2026-12-23T16:07:11Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 16:07:11.390871"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T16:07:11Z\",\"current_period_end\":\"2026-12-23T16:07:11Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 16:07:11.390871"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: f72f6f40-2ae9-46b5-8689-12a70ec6a19f) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:07:11 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:07:11Z", "current_period_end"=>"2026-12-23T16:07:11Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:07:11Z", "current_period_end"=>"2026-12-23T16:07:11Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:07:11 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:07:11Z", "current_period_end"=>"2026-12-23T16:07:11Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:07:11Z", "current_period_end"=>"2026-12-23T16:07:11Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 16:07:11.393103"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T16:07:11Z\",\"current_period_end\":\"2026-12-23T16:07:11Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 16:07:11.393103"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::WebhooksController::ProcessWebhookJob (Job ID: 23b0d8ed-d954-490b-9745-ce22cdb932ea) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 16:07:11"], ["status", "canceled"], ["updated_at", "2025-12-23 16:07:11.396739"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 16:07:11"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:07:11.407811"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 16:07:11"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:07:11.409376"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 16:07:11"], ["current_period_start", "2025-12-23 16:07:11"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:07:11.410516"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 11:07:11 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 11:07:11 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 11:07:11 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.6ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 16:07:11.499454"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 16:09:06.594347', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 16:09:06.594347')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 11:09:06 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 16ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 3.9ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 11:09:06 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 11:09:06 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.5ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:06 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:06Z", "current_period_end"=>"2026-12-23T16:09:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:06Z", "current_period_end"=>"2026-12-23T16:09:06Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:06 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:06Z", "current_period_end"=>"2026-12-23T16:09:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:06Z", "current_period_end"=>"2026-12-23T16:09:06Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 16:09:06.721957"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T16:09:06Z\",\"current_period_end\":\"2026-12-23T16:09:06Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 16:09:06.721957"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: fe8d5484-2e21-41a3-981f-b38fba2d80de) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:06 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:06Z", "current_period_end"=>"2026-12-23T16:09:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:06Z", "current_period_end"=>"2026-12-23T16:09:06Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 16:09:06.723601"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T16:09:06Z\",\"current_period_end\":\"2026-12-23T16:09:06Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 16:09:06.723601"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 01dc2efa-b0d8-47fc-9939-babad17d22e6) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:06 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:06Z", "current_period_end"=>"2026-12-23T16:09:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:06Z", "current_period_end"=>"2026-12-23T16:09:06Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:06 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:06Z", "current_period_end"=>"2026-12-23T16:09:06Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:06Z", "current_period_end"=>"2026-12-23T16:09:06Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 16:09:06.725785"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T16:09:06Z\",\"current_period_end\":\"2026-12-23T16:09:06Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 16:09:06.725785"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 0ace7622-3029-4904-8c58-4280d2c1b060) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:06 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.0ms)[0m  [1m[31mDELETE FROM "pay_subscriptions";
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 16:09:06.727954', '2026-01-23 16:09:06', '2025-11-23 16:09:06', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 16:09:06.727954')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 16:09:06"], ["status", "canceled"], ["updated_at", "2025-12-23 16:09:06.730403"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 16:09:06.745283"], ["current_period_end", "2026-12-23 16:09:06"], ["current_period_start", "2025-12-23 16:09:06"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 16:09:06.745283"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.0ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 16:09:06.747131"], ["current_period_end", "2026-12-23 16:09:06"], ["current_period_start", "2025-12-23 16:09:06"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 16:09:06.747131"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 16:09:06"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:09:06.748942"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 16:09:06.750990"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 16:09:06"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:09:06.752424"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 16:09:06"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:09:06.753783"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 16:09:06"], ["current_period_start", "2025-12-23 16:09:06"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:09:06.755453"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 16:09:18.442540', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 16:09:18.442540')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.0ms)[0m  [1m[31mDELETE FROM "pay_subscriptions";
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 16:09:18.477470', '2026-01-23 16:09:18', '2025-11-23 16:09:18', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 16:09:18.477470')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 16:09:18.483848"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 16:09:18.488603"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 16:09:18.488603"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 4e820618-b0fa-4766-884e-8a7457244b9a) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 16:09:18"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:09:18.494400"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 16:09:18"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:09:18.495660"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 16:09:18"], ["current_period_start", "2025-12-23 16:09:18"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:09:18.497633"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:18 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:18Z", "current_period_end"=>"2026-12-23T16:09:18Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:18Z", "current_period_end"=>"2026-12-23T16:09:18Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 16:09:18.502961"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T16:09:18Z\",\"current_period_end\":\"2026-12-23T16:09:18Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 16:09:18.502961"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: ff7c3310-22c1-4e35-8096-63321fc4378f) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:18 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:18Z", "current_period_end"=>"2026-12-23T16:09:18Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:18Z", "current_period_end"=>"2026-12-23T16:09:18Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 16:09:18.505112"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T16:09:18Z\",\"current_period_end\":\"2026-12-23T16:09:18Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 16:09:18.505112"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: cb081cb9-d9ff-41e6-96eb-5823d74ca36c) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:18 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:18Z", "current_period_end"=>"2026-12-23T16:09:18Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:18Z", "current_period_end"=>"2026-12-23T16:09:18Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:18 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:18 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:18Z", "current_period_end"=>"2026-12-23T16:09:18Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:18Z", "current_period_end"=>"2026-12-23T16:09:18Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 11:09:18 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:18Z", "current_period_end"=>"2026-12-23T16:09:18Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T16:09:18Z", "current_period_end"=>"2026-12-23T16:09:18Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 16:09:18.508965"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T16:09:18Z\",\"current_period_end\":\"2026-12-23T16:09:18Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 16:09:18.508965"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: ff0acc7f-7496-4d80-98e1-2552ee4138c7) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 11:09:18 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 11:09:18 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 11ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 2.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 11:09:18 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.5ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 16:09:18"], ["status", "canceled"], ["updated_at", "2025-12-23 16:09:18.594540"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 16:09:18.601554"], ["current_period_end", "2026-12-23 16:09:18"], ["current_period_start", "2025-12-23 16:09:18"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 16:09:18.601554"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 16:09:18.603337"], ["current_period_end", "2026-12-23 16:09:18"], ["current_period_start", "2025-12-23 16:09:18"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", nil], ["updated_at", "2025-12-23 16:09:18.603337"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 16:09:18"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 16:09:18.605210"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.7ms)[0m  [1m[31mDELETE FROM "pay_customers";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 18:29:02.619752', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, NULL, '2025-12-23 18:29:02.619752')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.0ms)[0m  [1m[31mDELETE FROM "pay_subscriptions";
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 18:29:02.649654', '2026-01-23 18:29:02', '2025-11-23 18:29:02', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, NULL, '2025-12-23 18:29:02.649654')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 18:29:02"], ["status", "canceled"], ["updated_at", "2025-12-23 18:29:02.655804"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 18:29:02.658063"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:29:02.668355"], ["current_period_end", "2026-12-23 18:29:02"], ["current_period_start", "2025-12-23 18:29:02"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:29:02.668355"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:29:02.676365"], ["current_period_end", "2026-12-23 18:29:02"], ["current_period_start", "2025-12-23 18:29:02"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:29:02.676365"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TO SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 18:29:02"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:29:02.688255"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 18:29:02"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:29:02.689516"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 18:29:02"], ["current_period_start", "2025-12-23 18:29:02"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:29:02.690908"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:29:02 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:29:02 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 3ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:29:02 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 0.6ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:29:02.783415"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:29:02.783415"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 83551018-45b7-4862-99dd-07b21cc61cb4) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:02 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:02Z", "current_period_end"=>"2026-12-23T18:29:02Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:02Z", "current_period_end"=>"2026-12-23T18:29:02Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:02 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:02Z", "current_period_end"=>"2026-12-23T18:29:02Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:02Z", "current_period_end"=>"2026-12-23T18:29:02Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:29:02.788873"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:29:02Z\",\"current_period_end\":\"2026-12-23T18:29:02Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:29:02.788873"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: b9f53f61-6574-4b8e-b69b-5373615d9482) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:02 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:02 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:02Z", "current_period_end"=>"2026-12-23T18:29:02Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:02Z", "current_period_end"=>"2026-12-23T18:29:02Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:29:02.791362"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:29:02Z\",\"current_period_end\":\"2026-12-23T18:29:02Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:29:02.791362"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 48e944fa-f793-4224-9162-c298adafbff3) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:02 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:02Z", "current_period_end"=>"2026-12-23T18:29:02Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:02Z", "current_period_end"=>"2026-12-23T18:29:02Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:02 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:02Z", "current_period_end"=>"2026-12-23T18:29:02Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:02Z", "current_period_end"=>"2026-12-23T18:29:02Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:29:02.793608"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:29:02Z\",\"current_period_end\":\"2026-12-23T18:29:02Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:29:02.793608"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: a85c0886-4844-41db-a4b0-765996722cce) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 18:29:43.955922', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2025-12-23 18:29:43.955922');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 18:29:43.955973', '2026-01-23 18:29:43', '2025-11-23 18:29:43', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2025-12-23 18:29:43.955973')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 18:29:43"], ["status", "canceled"], ["updated_at", "2025-12-23 18:29:43.974512"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:29:43.977935"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:29:43.977935"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 48cfcb03-bf3b-4331-ad3b-0069990536d0) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 18:29:43"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:29:43.986007"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:29:43.990617"], ["current_period_end", "2026-12-23 18:29:43"], ["current_period_start", "2025-12-23 18:29:43"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:29:43.990617"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:29:43.996291"], ["current_period_end", "2026-12-23 18:29:43"], ["current_period_start", "2025-12-23 18:29:43"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:29:43.996291"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-01-23 18:29:44"], ["current_period_start", "2025-12-23 18:29:44"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:29:44.019896"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-01-23 18:29:44"], ["current_period_start", "2025-12-23 18:29:44"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:29:44.021256"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 18:29:44"], ["current_period_start", "2025-12-23 18:29:44"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:29:44.022597"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:44Z", "current_period_end"=>"2026-12-23T18:29:44Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:44Z", "current_period_end"=>"2026-12-23T18:29:44Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:44Z", "current_period_end"=>"2026-12-23T18:29:44Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:44Z", "current_period_end"=>"2026-12-23T18:29:44Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:29:44.044000"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:29:44Z\",\"current_period_end\":\"2026-12-23T18:29:44Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:29:44.044000"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 9546d384-7eda-493a-a7d1-c864b35e5f18) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:44Z", "current_period_end"=>"2026-12-23T18:29:44Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:44Z", "current_period_end"=>"2026-12-23T18:29:44Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:29:44.045876"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:29:44Z\",\"current_period_end\":\"2026-12-23T18:29:44Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:29:44.045876"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 63a3cff7-3649-47ad-b7a4-1fbefe8c671d) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:44Z", "current_period_end"=>"2026-12-23T18:29:44Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:44Z", "current_period_end"=>"2026-12-23T18:29:44Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:29:44.047345"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:29:44Z\",\"current_period_end\":\"2026-12-23T18:29:44Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:29:44.047345"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 9c6d0bb9-3b14-4a83-9304-a298f6d68258) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:44Z", "current_period_end"=>"2026-12-23T18:29:44Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:29:44Z", "current_period_end"=>"2026-12-23T18:29:44Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:29:44 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 18:29:44.051844"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:29:44 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.8ms | GC: 0.1ms)
Completed 200 OK in 8ms (Views: 2.2ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.3ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:29:44 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:29:44 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 18:30:05.397636', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2025-12-23 18:30:05.397636');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 18:30:05.399043', '2026-01-23 18:30:05', '2025-11-23 18:30:05', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2025-12-23 18:30:05.399043')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 18:30:05"], ["current_period_start", "2025-12-23 18:30:05"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:30:05.417471"], ["id", 1]]
  [1m[36mTRANSACTION (3.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 18:30:05"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:30:05.429437"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.1ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 18:30:05"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:30:05.431876"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 18:30:05.434094"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:30:05 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.9ms | GC: 0.0ms)
Completed 200 OK in 9ms (Views: 3.4ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:30:05 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:30:05 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 18:30:05"], ["status", "canceled"], ["updated_at", "2025-12-23 18:30:05.552599"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 18:30:05"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:30:05.554644"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:30:05.559187"], ["current_period_end", "2026-12-23 18:30:05"], ["current_period_start", "2025-12-23 18:30:05"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:30:05.559187"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:30:05.564820"], ["current_period_end", "2026-12-23 18:30:05"], ["current_period_start", "2025-12-23 18:30:05"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:30:05.564820"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:30:05.576969"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:30:05.576969"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 886c7761-1230-4994-ad9c-f8d468c69f7c) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:05 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:05 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:05Z", "current_period_end"=>"2026-12-23T18:30:05Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:05Z", "current_period_end"=>"2026-12-23T18:30:05Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:30:05.581788"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:30:05Z\",\"current_period_end\":\"2026-12-23T18:30:05Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:30:05.581788"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 62cda626-76f8-4071-9ccf-934f025752ce) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:05 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:05Z", "current_period_end"=>"2026-12-23T18:30:05Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:05Z", "current_period_end"=>"2026-12-23T18:30:05Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:05 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:05Z", "current_period_end"=>"2026-12-23T18:30:05Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:05Z", "current_period_end"=>"2026-12-23T18:30:05Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:30:05.584297"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:30:05Z\",\"current_period_end\":\"2026-12-23T18:30:05Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:30:05.584297"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 5bd4d377-abb3-408f-906f-b00ed14229e1) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:05 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:05Z", "current_period_end"=>"2026-12-23T18:30:05Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:05Z", "current_period_end"=>"2026-12-23T18:30:05Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:30:05.587585"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:30:05Z\",\"current_period_end\":\"2026-12-23T18:30:05Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:30:05.587585"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: b9570b4c-afd2-40d8-91b2-28477ee7cb76) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:05 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:05Z", "current_period_end"=>"2026-12-23T18:30:05Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:05Z", "current_period_end"=>"2026-12-23T18:30:05Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 18:30:22.736814', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2025-12-23 18:30:22.736814');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 18:30:22.737997', '2026-01-23 18:30:22', '2025-11-23 18:30:22', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2025-12-23 18:30:22.737997')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:30:22.760016"], ["current_period_end", "2026-12-23 18:30:22"], ["current_period_start", "2025-12-23 18:30:22"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:30:22.760016"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_subscription_methods_raise_appropriate_errors
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:30:22.764966"], ["current_period_end", "2026-12-23 18:30:22"], ["current_period_start", "2025-12-23 18:30:22"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_sti_test"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:30:22.764966"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.0ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:30:22.766542"], ["current_period_end", "2026-12-23 18:30:22"], ["current_period_start", "2025-12-23 18:30:22"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:30:22.766542"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 18:30:22"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:30:22.768310"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 18:30:22.794270"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 18:30:22"], ["status", "canceled"], ["updated_at", "2025-12-23 18:30:22.796291"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 18:30:22"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:30:22.797991"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_start", "2025-12-23 18:30:22"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:30:22.799902"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 18:30:22"], ["current_period_start", "2025-12-23 18:30:22"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:30:22.801082"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:30:22.803602"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:30:22.803602"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: f123c8f2-0f09-4b33-aa1f-eea1b3a53f44) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:30:22 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 4ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:30:22 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 1.9ms | GC: 1.8ms)
Completed 200 OK in 3ms (Views: 2.7ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 1.8ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:30:22 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:22Z", "current_period_end"=>"2026-12-23T18:30:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:22Z", "current_period_end"=>"2026-12-23T18:30:22Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:30:22.887051"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:30:22Z\",\"current_period_end\":\"2026-12-23T18:30:22Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:30:22.887051"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 602cd0c7-7279-4a60-8119-dba9fbed500a) to Test(default) with arguments: 1
Completed 200 OK in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:22Z", "current_period_end"=>"2026-12-23T18:30:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:22Z", "current_period_end"=>"2026-12-23T18:30:22Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:30:22.888639"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:30:22Z\",\"current_period_end\":\"2026-12-23T18:30:22Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:30:22.888639"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 6778b7a1-b7fc-4130-9f65-e68ea159526c) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:22Z", "current_period_end"=>"2026-12-23T18:30:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:22Z", "current_period_end"=>"2026-12-23T18:30:22Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:22Z", "current_period_end"=>"2026-12-23T18:30:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:22Z", "current_period_end"=>"2026-12-23T18:30:22Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:30:22 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:22Z", "current_period_end"=>"2026-12-23T18:30:22Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:30:22Z", "current_period_end"=>"2026-12-23T18:30:22Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:30:22.891781"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:30:22Z\",\"current_period_end\":\"2026-12-23T18:30:22Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:30:22.891781"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 73de1bf6-41ef-4130-a1a4-9db43dea0324) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.1ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.2ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "pay_customers";
DELETE FROM "pay_subscriptions";
INSERT INTO "pay_customers" ("id", "created_at", "data", "default", "deleted_at", "object", "owner_id", "owner_type", "processor", "processor_id", "stripe_account", "type", "updated_at") VALUES (1, '2025-12-23 18:32:19.983675', NULL, NULL, NULL, NULL, 1, 'User', 'purchasekit', 'cus_test123', NULL, 'Pay::Purchasekit::Customer', '2025-12-23 18:32:19.983675');
INSERT INTO "pay_subscriptions" ("id", "application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (1, NULL, '2025-12-23 18:32:19.984812', '2026-01-23 18:32:19', '2025-11-23 18:32:19', 1, NULL, NULL, NULL, NULL, 'pro', NULL, NULL, NULL, NULL, NULL, 'sub_existing', 'com.example.annual', 1, 'active', NULL, NULL, 'Pay::Purchasekit::Subscription', '2025-12-23 18:32:19.984812')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_key_check[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_sets_subscription_status_to_canceled
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "ends_at" = ?, "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["ends_at", "2026-01-23 18:32:20"], ["status", "canceled"], ["updated_at", "2025-12-23 18:32:20.003146"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCanceledTest: test_handles_missing_subscription_gracefully
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_sets_subscription_status_to_expired
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "status" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["status", "expired"], ["updated_at", "2025-12-23 18:32:20.006459"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionExpiredTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_renders_radio_and_label
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_submit_renders_disabled_button_with_data_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_renders_form_with_correct_attributes
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_with_custom_text
-----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_plan_option_not_selected_by_default
-----------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_raises_outside_plan_option_block
--------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_includes_hidden_fields
------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_restore_link_renders_link_with_action
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_defaults_success_path_to_root
-------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_purchasekit_paywall_raises_without_customer
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_renders_span_with_data_attributes
---------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------
PurchaseKit::Pay::PaywallHelperTest: test_price_with_custom_loading_content
---------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_request_without_signature_when_secret_blank
--------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:32:20 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:32:20Z", "current_period_end"=>"2026-12-23T18:32:20Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:32:20Z", "current_period_end"=>"2026-12-23T18:32:20Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:32:20.038739"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:32:20Z\",\"current_period_end\":\"2026-12-23T18:32:20Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:32:20.038739"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 610438ad-f4bc-456d-aa85-151b3ed9bed0) to Test(default) with arguments: 1
Completed 200 OK in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.2ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_creates_webhook_record_with_correct_attributes
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:32:20 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:32:20Z", "current_period_end"=>"2026-12-23T18:32:20Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:32:20Z", "current_period_end"=>"2026-12-23T18:32:20Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:32:20.041155"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:32:20Z\",\"current_period_end\":\"2026-12-23T18:32:20Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:32:20.041155"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 58ffd4f3-b3a0-4e23-8102-bf5a8d16719e) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_accepts_valid_signature
----------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:32:20 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:32:20Z", "current_period_end"=>"2026-12-23T18:32:20Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:32:20Z", "current_period_end"=>"2026-12-23T18:32:20Z", "success_path"=>"/dashboard"}}
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:32:20.042860"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1,\"subscription_id\":\"sub_123\",\"store\":\"apple\",\"store_product_id\":\"com.example.annual\",\"subscription_name\":\"pro\",\"status\":\"active\",\"current_period_start\":\"2025-12-23T18:32:20Z\",\"current_period_end\":\"2026-12-23T18:32:20Z\",\"success_path\":\"/dashboard\"}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:32:20.042860"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 5f750212-8764-466f-8c11-2d5db8d8b0e0) to Test(default) with arguments: 1
Completed 200 OK in 0ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_missing_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:32:20 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:32:20Z", "current_period_end"=>"2026-12-23T18:32:20Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:32:20Z", "current_period_end"=>"2026-12-23T18:32:20Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Missing signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_ignores_unregistered_event_types
-------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:32:20 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"unknown.event", "webhook"=>{"type"=>"unknown.event"}}
Completed 200 OK in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhooksControllerTest: test_rejects_invalid_signature
------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
Started POST "/purchasekit/webhooks" for 127.0.0.1 at 2025-12-23 13:32:20 -0500
Processing by PurchaseKit::Pay::WebhooksController#create as HTML
  Parameters: {"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:32:20Z", "current_period_end"=>"2026-12-23T18:32:20Z", "success_path"=>"/dashboard", "webhook"=>{"type"=>"subscription.created", "customer_id"=>1, "subscription_id"=>"sub_123", "store"=>"apple", "store_product_id"=>"com.example.annual", "subscription_name"=>"pro", "status"=>"active", "current_period_start"=>"2025-12-23T18:32:20Z", "current_period_end"=>"2026-12-23T18:32:20Z", "success_path"=>"/dashboard"}}
[PurchaseKit] Webhook signature error: Invalid signature
Completed 400 Bad Request in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_skips_unregistered_event_types
------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mCACHE Pay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
PurchaseKit::Pay::WebhookTest: test_queue_creates_webhook_record_and_enqueues_job
---------------------------------------------------------------------------------
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Webhook Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_webhooks" ("created_at", "event", "event_type", "processor", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["created_at", "2025-12-23 18:32:20.047503"], ["event", "{\"type\":\"subscription.created\",\"customer_id\":1}"], ["event_type", "subscription.created"], ["processor", "purchasekit"], ["updated_at", "2025-12-23 18:32:20.047503"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
[ActiveJob] Enqueued PurchaseKit::Pay::Webhook::ProcessWebhookJob (Job ID: 637888dc-e51f-4183-9bc3-31f62df915a9) to Test(default) with arguments: 1
  [1m[36mPay::Webhook Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "pay_webhooks"[0m
  [1m[36mPay::Webhook Load (0.0ms)[0m  [1m[34mSELECT "pay_webhooks".* FROM "pay_webhooks" ORDER BY "pay_webhooks"."id" DESC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_updates_existing_subscription_without_broadcast
---------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "data" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-01-23 18:32:20"], ["current_period_start", "2025-12-23 18:32:20"], ["data", "{\"store\":\"apple\"}"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:32:20.050108"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_subscription_methods_raise_appropriate_errors
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:32:20.053756"], ["current_period_end", "2026-12-23 18:32:20"], ["current_period_start", "2025-12-23 18:32:20"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_sti_test"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:32:20.053756"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_sti_test"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_stores_google_store_in_data
-------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_google123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:32:20.055322"], ["current_period_end", "2026-12-23 18:32:20"], ["current_period_start", "2025-12-23 18:32:20"], ["customer_id", 1], ["data", "{\"store\":\"google\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_google123"], ["processor_plan", "annual_subscription"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:32:20.055322"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.1ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_google123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionCreatedTest: test_creates_new_subscription_and_broadcasts_redirect
----------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mCACHE Pay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_new123"], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Create (0.1ms)[0m  [1m[32mINSERT INTO "pay_subscriptions" ("application_fee_percent", "created_at", "current_period_end", "current_period_start", "customer_id", "data", "ends_at", "metadata", "metered", "name", "object", "pause_behavior", "pause_resumes_at", "pause_starts_at", "payment_method_id", "processor_id", "processor_plan", "quantity", "status", "stripe_account", "trial_ends_at", "type", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["application_fee_percent", nil], ["created_at", "2025-12-23 18:32:20.059590"], ["current_period_end", "2026-12-23 18:32:20"], ["current_period_start", "2025-12-23 18:32:20"], ["customer_id", 1], ["data", "{\"store\":\"apple\"}"], ["ends_at", nil], ["metadata", nil], ["metered", nil], ["name", "pro"], ["object", nil], ["pause_behavior", nil], ["pause_resumes_at", nil], ["pause_starts_at", nil], ["payment_method_id", nil], ["processor_id", "sub_new123"], ["processor_plan", "com.example.annual"], ["quantity", 1], ["status", "active"], ["stripe_account", nil], ["trial_ends_at", nil], ["type", "Pay::Purchasekit::Subscription"], ["updated_at", "2025-12-23 18:32:20.059590"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."customer_id" = ? AND "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["customer_id", 1], ["processor_id", "sub_new123"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_turbo_stream_with_intent_data
--------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:32:20 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  Rendering /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/create.turbo_stream.erb (Duration: 0.5ms | GC: 0.0ms)
Completed 200 OK in 6ms (Views: 1.8ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_returns_not_found_for_missing_customer
---------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:32:20 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"999999", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"sandbox"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 999999], ["LIMIT", 1]]
Completed 404 Not Found in 0ms (ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  
ActiveRecord::RecordNotFound (Couldn't find Pay::Customer with 'id'="999999"):
  
activerecord (8.1.1) lib/active_record/core.rb:279:in `find'
/Users/joemasilotti/workspace/projects/purchasekit/gem/app/controllers/purchase_kit/pay/purchases_controller.rb:5:in `create'
actionpack (8.1.1) lib/action_controller/metal/basic_implicit_render.rb:8:in `send_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:221:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rendering.rb:199:in `process_action'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:267:in `block in process_action'
activesupport (8.1.1) lib/active_support/callbacks.rb:121:in `block in run_callbacks'
turbo-rails (2.0.20) lib/turbo-rails.rb:24:in `with_request_id'
turbo-rails (2.0.20) app/controllers/concerns/turbo/request_id_tracking.rb:10:in `turbo_tracking_request_id'
activesupport (8.1.1) lib/active_support/callbacks.rb:130:in `block in run_callbacks'
activesupport (8.1.1) lib/active_support/callbacks.rb:141:in `run_callbacks'
actionpack (8.1.1) lib/abstract_controller/callbacks.rb:266:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/rescue.rb:36:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:76:in `block in process_action'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `block in instrument'
activesupport (8.1.1) lib/active_support/notifications/instrumenter.rb:58:in `instrument'
activesupport (8.1.1) lib/active_support/notifications.rb:210:in `instrument'
actionpack (8.1.1) lib/action_controller/metal/instrumentation.rb:75:in `process_action'
actionpack (8.1.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'
activerecord (8.1.1) lib/active_record/railties/controller_runtime.rb:39:in `process_action'
actionpack (8.1.1) lib/abstract_controller/base.rb:154:in `process'
actionview (8.1.1) lib/action_view/rendering.rb:40:in `process'
actionpack (8.1.1) lib/action_controller/metal.rb:252:in `dispatch'
actionpack (8.1.1) lib/action_controller/metal.rb:335:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:65:in `dispatch'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:50:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:86:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
railties (8.1.1) lib/rails/railtie.rb:225:in `public_send'
railties (8.1.1) lib/rails/railtie.rb:225:in `method_missing'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:33:in `block in <class:Constraints>'
actionpack (8.1.1) lib/action_dispatch/routing/mapper.rb:62:in `serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:35:in `block in serve'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:92:in `block in recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `each'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:66:in `recognize'
actionpack (8.1.1) lib/action_dispatch/journey/router.rb:31:in `serve'
actionpack (8.1.1) lib/action_dispatch/routing/route_set.rb:906:in `call'
railties (8.1.1) lib/rails/engine/lazy_route_set.rb:60:in `call'
rack (3.2.4) lib/rack/tempfile_reaper.rb:20:in `call'
rack (3.2.4) lib/rack/etag.rb:29:in `call'
rack (3.2.4) lib/rack/conditional_get.rb:44:in `call'
rack (3.2.4) lib/rack/head.rb:15:in `call'
actionpack (8.1.1) lib/action_dispatch/http/content_security_policy.rb:38:in `call'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:274:in `context'
rack-session (2.1.1) lib/rack/session/abstract/id.rb:268:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/cookies.rb:708:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:31:in `block in call'
activesupport (8.1.1) lib/active_support/callbacks.rb:101:in `run_callbacks'
actionpack (8.1.1) lib/action_dispatch/middleware/callbacks.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/debug_exceptions.rb:31:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/show_exceptions.rb:32:in `call'
railties (8.1.1) lib/rails/rack/logger.rb:41:in `call_app'
railties (8.1.1) lib/rails/rack/logger.rb:29:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/remote_ip.rb:98:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/request_id.rb:34:in `call'
rack (3.2.4) lib/rack/method_override.rb:28:in `call'
rack (3.2.4) lib/rack/runtime.rb:24:in `call'
activesupport (8.1.1) lib/active_support/cache/strategy/local_cache_middleware.rb:30:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/executor.rb:20:in `call'
propshaft (1.3.1) lib/propshaft/server.rb:37:in `call'
actionpack (8.1.1) lib/action_dispatch/middleware/static.rb:27:in `call'
rack (3.2.4) lib/rack/sendfile.rb:131:in `call'
railties (8.1.1) lib/rails/engine.rb:534:in `call'
rack-test (2.2.0) lib/rack/test.rb:360:in `process_request'
rack-test (2.2.0) lib/rack/test.rb:153:in `request'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:297:in `process'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:25:in `post'
actionpack (8.1.1) lib/action_dispatch/testing/integration.rb:388:in `post'
/Users/joemasilotti/workspace/projects/purchasekit/gem/test/controllers/purchases_controller_test.rb:48:in `test_create_returns_not_found_for_missing_customer'
minitest (5.27.0) lib/minitest/test.rb:95:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest/test.rb:191:in `capture_exceptions'
minitest (5.27.0) lib/minitest/test.rb:90:in `block in run'
minitest (5.27.0) lib/minitest.rb:382:in `time_it'
minitest (5.27.0) lib/minitest/test.rb:89:in `run'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `block in run'
activesupport (8.1.1) lib/active_support/execution_wrapper.rb:104:in `perform'
activesupport (8.1.1) lib/active_support/executor/test_helper.rb:5:in `run'
minitest (5.27.0) lib/minitest.rb:1223:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:462:in `run_one_method'
minitest (5.27.0) lib/minitest.rb:449:in `block (2 levels) in run'
minitest (5.27.0) lib/minitest.rb:445:in `each'
minitest (5.27.0) lib/minitest.rb:445:in `block in run'
minitest (5.27.0) lib/minitest.rb:487:in `on_signal'
minitest (5.27.0) lib/minitest.rb:474:in `with_info_handler'
minitest (5.27.0) lib/minitest.rb:444:in `run'
railties (8.1.1) lib/rails/test_unit/line_filtering.rb:10:in `run'
minitest (5.27.0) lib/minitest.rb:346:in `block in __run'
minitest (5.27.0) lib/minitest.rb:346:in `map'
minitest (5.27.0) lib/minitest.rb:346:in `__run'
minitest (5.27.0) lib/minitest.rb:301:in `run'
minitest (5.27.0) lib/minitest.rb:85:in `block in autorun'
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------
PurchaseKit::Pay::PurchasesControllerTest: test_create_handles_subscription_required_error
------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.1ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
Started POST "/purchasekit/purchases" for 127.0.0.1 at 2025-12-23 13:32:20 -0500
Processing by PurchaseKit::Pay::PurchasesController#create as TURBO_STREAM
  Parameters: {"customer_id"=>"1", "product_id"=>"prod_TEST123", "success_path"=>"/dashboard", "environment"=>"production"}
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
rescue_from handled PurchaseKit::Pay::SubscriptionRequiredError (Subscription required for production purchases) - /Users/joemasilotti/workspace/projects/purchasekit/gem/lib/purchasekit/purchase/intent.rb:31:in `create'
  Rendered /Users/joemasilotti/workspace/projects/purchasekit/gem/app/views/purchase_kit/pay/purchases/_subscription_required.html.erb (Duration: 0.1ms | GC: 0.0ms)
Completed 200 OK in 1ms (Views: 0.0ms | ActiveRecord: 0.0ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_updates_subscription_status_and_dates
-----------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-02-23 18:32:20"], ["current_period_start", "2025-12-23 18:32:20"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:32:20.139852"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Purchasekit::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."type" = ? AND "pay_subscriptions"."id" = ? LIMIT ?[0m  [["type", "Pay::Purchasekit::Subscription"], ["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_handles_missing_subscription_gracefully
-------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_nonexistent"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_does_not_broadcast_when_success_path_missing
------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-01-23 18:32:20"], ["current_period_start", "2025-12-23 18:32:20"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:32:20.142567"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------------------------------------------------
PurchaseKit::Pay::Webhooks::SubscriptionUpdatedTest: test_broadcasts_redirect_when_success_path_present
-------------------------------------------------------------------------------------------------------
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mPay::Subscription Load (0.0ms)[0m  [1m[34mSELECT "pay_subscriptions".* FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPay::Subscription Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "pay_subscriptions" WHERE "pay_subscriptions"."processor_id" = ? AND "pay_subscriptions"."id" != ? AND "pay_subscriptions"."customer_id" = ? LIMIT ?[0m  [["processor_id", "sub_existing"], ["id", 1], ["customer_id", 1], ["LIMIT", 1]]
  [1m[36mPay::Purchasekit::Subscription Update (0.0ms)[0m  [1m[33mUPDATE "pay_subscriptions" SET "current_period_end" = ?, "current_period_start" = ?, "processor_plan" = ?, "updated_at" = ? WHERE "pay_subscriptions"."id" = ?[0m  [["current_period_end", "2026-01-23 18:32:20"], ["current_period_start", "2025-12-23 18:32:20"], ["processor_plan", "com.example.monthly"], ["updated_at", "2025-12-23 18:32:20.144041"], ["id", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mPay::Customer Load (0.0ms)[0m  [1m[34mSELECT "pay_customers".* FROM "pay_customers" WHERE "pay_customers"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
